const chronometryApp=new Vue({el:"#chronometry-app",data:{isReady:!1,isOnline:"",requestToken:"",modalId:null,currentTime:"",runners:null,categories:null,modal:{runnerIndex:null,runnerNumber:"",runnerFullname:"",runnerId:null,runnerIsFinisher:!1,runnerdnf:!1,lastChange:"",endTime:""},searchForm:{showNumberDropdown:!1,numberSuggests:[],showNameDropdown:!1,nameSuggests:[]},stats:{total:0,dispensed:0,haveFinished:0,running:0,haveGivenUp:0,runnersTotal:0}},created:function(){const e=this;e.requestToken=CHRONOMETRY.requestToken,e.modalId=CHRONOMETRY.modalId,window.setTimeout(function(){e.isReady=!0},2e3),window.setInterval(function(){e.setTime()},1e3),e.checkOnlineStatus(),window.setInterval(function(){e.checkOnlineStatus()},15e3),e.getDataAll(),$(document).ready(function(){$("#startlistTable").stupidtable()})},methods:{getDataAll:function(){const e=this,t=$.ajax({url:window.location.href+"?action=getDataAll",type:"get",dataType:"json"});t.done(function(t){e.runners=t.runners,e.stats=t.stats,e.categories=t.categories}),t.fail(function(){alert("XHR-Request fehlgeschlagen!!!")}),t.always(function(){})},openModal:function(e){const t=this,n=t.runners[e],r=t.modal;r.runnerIndex=e,r.runnerNumber=n.number,r.runnerFullname=n.fullname,r.runnerIsFinisher=""!==n.endtime,r.runnerHasNotice=""!==n.notice,r.runnerdnf="1"===n.dnf,r.runnerNotice=n.notice.replace(/&\am\p;/g,"&"),r.runnerId=n.id;const s=new Date(1e3*n.tstamp);r.lastChange="Letzte Änderung: "+t.getFormatedTime(s),r.endTime=""===n.endtime?t.currentTime:n.endtime,r.endTime="1"===n.dnf?"":r.endTime,document.getElementById("runnerDnfCtrl").checked="1"===n.dnf;let o=document.getElementById(t.modalId);o.addEventListener("hidden.bs.modal",function(){$("html, body").animate({},50,function(){$("#searchNumber").val("").focus(),$("#searchName").val(""),t.searchForm.numberSuggests=[],t.searchForm.nameSuggests=[],t.searchForm.showNumberDropdown=!1,t.searchForm.showNameDropdown=!1})}),o.addEventListener("shown.bs.modal",function(){$("#endtimeCtrl").focus()}),bootstrap.Modal.getOrCreateInstance(o,{keyboard:!1}).show(),$("#inputClear").click(function(){r.endTime=""})},scrollToNumber:function(e){const t=this,n=e.target;if($(n).val()>1){const e=$("tr[data-number='"+$(n).val()+"']");if($(e).length){$("html, body").animate({scrollTop:$(e).offset().top-40},400,function(){});const n=$(e).data("index");t.openModal(n)}}},checkOnlineStatus:function(){const e=this,t=$.ajax({url:window.location.href+"?action=checkOnlineStatus",type:"get",dataType:"json"});t.done(function(t){e.isOnline="success"===t.status}),t.fail(function(){e.isOnline=!1}),t.always(function(){})},saveRow:function(e){const t=this,n=(t.runners[e],t.modal.runnerId),r=$("#endtimeCtrl").val(),s=$(".modal #runnerDnfCtrl").is(":checked")?1:"";if(/^(([0|1][0-9])|([2][0-3])):([0-5][0-9]):([0-5][0-9])$/.test(r)||""===r){let o=document.getElementById(t.modalId);bootstrap.Modal.getOrCreateInstance(o,{keyboard:!1}).hide();const a=$.ajax({url:window.location.href+"?action=saveRow",type:"post",dataType:"json",data:{REQUEST_TOKEN:t.requestToken,id:n,index:e,endtime:r,dnf:s}});a.done(function(e){"success"===e.status?(t.runners=e.runners,t.stats=e.stats,t.categories=e.categories):alert("Fehler")}),a.fail(function(){alert("XHR-Request für id "+n+" fehlgeschlagen!!!")})}else alert("Ungültige Eingabe: "+r)},setTime:function(){let e=new Date,t=e.getHours(),n=e.getMinutes(),r=e.getSeconds();t<10&&(t="0"+t),n<10&&(n="0"+n),r<10&&(r="0"+r),this.currentTime=t+":"+n+":"+r},setEndTimeFromCurrentTime:function(){const e=this.modal,t=new Date;e.endTime=this.getFormatedTime(t)},clearEndTime:function(){this.modal.endTime=""},onInputNumber:function(e){this.validateNumberOnInput(e),this.showNumberDropdownSuggest(e)},validateNumberOnInput:function(e){const t=e.target;t.value=t.value.replace(/[^0-9]/g,"")},showNumberDropdownSuggest:function(e){const t=this,n=e.target;if(""===$(n).val())return t.searchForm.numberSuggests=[],void(t.searchForm.showNumberDropdown=!1);$("#searchName").val(""),t.searchForm.nameSuggests=[],t.searchForm.showNameDropdown=!1;const r=$("#startlistTable tbody tr"),s=new RegExp("^"+$(n).val()+"(.*)","i");t.searchForm.numberSuggests=[],r.each(function(){if(s.test($(this).attr("data-number"))){const e={index:$(this).attr("data-index"),number:$(this).attr("data-number"),fullname:$(this).attr("data-fullname")};t.searchForm.numberSuggests.push(e),t.searchForm.showNumberDropdown=!0}})},removeNumberDropdownSuggest:function(e){const t=this,n=e.target;window.setTimeout(function(){$(n).val(""),t.searchForm.numberSuggests=[],t.searchForm.showNumberDropdown=!1},50)},showNameDropdownSuggest:function(e){const t=this,n=e.target;if(""===$(n).val())return t.searchForm.nameSuggests=[],void(t.searchForm.showNameDropdown=!1);$("#searchNumber").val(""),t.searchForm.numberSuggests=[],t.searchForm.showNumberDropdown=!1;const r=$("#startlistTable tbody tr"),s=new RegExp($(n).val()+"(.*)","i");t.searchForm.nameSuggests=[],r.each(function(){if(s.test($(this).attr("data-fullname"))){const e={index:$(this).attr("data-index"),number:$(this).attr("data-number"),fullname:$(this).attr("data-fullname")};t.searchForm.nameSuggests.push(e),t.searchForm.showNameDropdown=!0}})},removeNameDropdownSuggest:function(e){const t=this,n=e.target;window.setTimeout(function(){$(n).val(""),t.searchForm.nameSuggests=[],t.searchForm.showNameDropdown=!1},50)},applyFilter:function(e){const t=e.target,n=$(t).val(),r=$(".startlist-table tbody tr");r.removeClass("d-none"),"0"!==n&&r.each(function(){$(this).attr("data-category")!==n&&$(this).addClass("d-none")})},getFormatedTime:function(e){return(e.getHours()<10?"0"+e.getHours():e.getHours())+":"+(e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes())+":"+(e.getSeconds()<10?"0"+e.getSeconds():e.getSeconds())}}});