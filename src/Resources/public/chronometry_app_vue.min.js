/*
 * This file is part of Chronometry Bundle.
 *
 * (c) Marko Cupic 2022 <m.cupic@gmx.ch>
 * @license LGPL-3.0+
 * For the full copyright and license information,
 * please view the LICENSE file that was distributed with this source code.
 * @link https://github.com/markocupic/chronometry-bundle
 */ const a=new Vue({el:"#chronometry-app",data:{isReady:!1,isOnline:"",requestToken:"",modalId:null,currentTime:"",runners:null,categories:null,modal:{runnerIndex:null,runnerNumber:"",runnerFullname:"",runnerId:null,runnerIsFinisher:!1,runnerdnf:!1,lastChange:"",endTime:""},searchForm:{showNumberDropdown:!1,numberSuggests:[],showNameDropdown:!1,nameSuggests:[]},stats:{total:0,dispensed:0,haveFinished:0,running:0,haveGivenUp:0,runnersTotal:0}},created:function(){let a=this;a.requestToken=CHRONOMETRY.requestToken,a.modalId=CHRONOMETRY.modalId,window.setTimeout(function(){a.isReady=!0},2e3),window.setInterval(function(){a.setTime()},1e3),a.checkOnlineStatus(),window.setInterval(function(){a.checkOnlineStatus()},15e3),a.getDataAll(),$(document).ready(function(){$("#startlistTable").stupidtable()})},methods:{getDataAll:function(){let a=this;fetch(window.location.href+"?action=getDataAll",{method:"GET",headers:{"Content-Type":"application/json"}}).then(a=>a.json()).then(b=>{a.runners=b.runners,a.stats=b.stats,a.categories=b.categories}).catch(a=>{console.error("XHR-request failed!!!:",a)})},openModal:function(e){let c=this,a=c.runners[e],b=c.modal;b.runnerIndex=e,b.runnerNumber=a.number,b.runnerFullname=a.fullname,b.runnerIsFinisher=""!==a.endtime,b.runnerHasNotice=""!==a.notice,b.runnerdnf="1"===a.dnf,b.runnerNotice=a.notice.replace(/&\am\p;/g,"&"),b.runnerId=a.id;let f=new Date(1e3*a.tstamp);b.lastChange="Letzte \xc4nderung: "+c.getFormatedTime(f),b.endTime=""===a.endtime?c.currentTime:a.endtime,b.endTime="1"===a.dnf?"":b.endTime,document.getElementById("runnerDnfCtrl").checked="1"===a.dnf;let d=document.getElementById(c.modalId);d.addEventListener("hidden.bs.modal",function(){$("html, body").animate({},50,function(){$("#searchNumber").val("").focus(),$("#searchName").val(""),c.searchForm.numberSuggests=[],c.searchForm.nameSuggests=[],c.searchForm.showNumberDropdown=!1,c.searchForm.showNameDropdown=!1})}),d.addEventListener("shown.bs.modal",function(){$("#endtimeCtrl").focus()}),bootstrap.Modal.getOrCreateInstance(d,{keyboard:!1}).show(),$("#inputClear").click(function(){b.endTime=""})},scrollToNumber:function(c){let b=c.target;if($(b).val()>1){let a=$("tr[data-number='"+$(b).val()+"']");if($(a).length){$("html, body").animate({scrollTop:$(a).offset().top-40},400,function(){});let d=$(a).data("index");this.openModal(d)}}},checkOnlineStatus:function(){let a=this;fetch(window.location.href+"?action=checkOnlineStatus",{method:"GET",headers:{"Content-Type":"application/json"}}).then(a=>a.json()).then(b=>{a.isOnline="success"===b.status}).catch(b=>{a.isOnline=!1})},saveRow:function(d){let b=this;b.runners[d];let e=b.modal,f=e.runnerId,c=$("#endtimeCtrl").val(),g=$(".modal #runnerDnfCtrl").is(":checked")?1:"";if(/^(([0|1][0-9])|([2][0-3])):([0-5][0-9]):([0-5][0-9])$/.test(c)||""===c){let h=document.getElementById(b.modalId);bootstrap.Modal.getOrCreateInstance(h,{keyboard:!1}).hide();let a=new FormData;a.append("REQUEST_TOKEN",b.requestToken),a.append("id",f),a.append("index",d),a.append("endtime",c),a.append("dnf",g),fetch(window.location.href+"?action=saveRow",{method:"POST",headers:{Accept:"application/json"},body:a}).then(a=>a.json()).then(a=>{b.runners=a.runners,b.stats=a.stats,b.categories=a.categories}).catch(a=>{console.error("Upload error. Could not save data.",a)})}else alert('Invalid input format for "endtime": '+c)},setTime:function(){let d=new Date,a=d.getHours(),b=d.getMinutes(),c=d.getSeconds();a<10&&(a="0"+a),b<10&&(b="0"+b),c<10&&(c="0"+c),this.currentTime=a+":"+b+":"+c},setEndTimeFromCurrentTime:function(){let a=this.modal,b=new Date;a.endTime=this.getFormatedTime(b)},clearEndTime:function(){let a=this;a.modal.endTime=""},onInputNumber:function(a){this.validateNumberOnInput(a),this.showNumberDropdownSuggest(a)},validateNumberOnInput:function(b){let a=b.target;a.value=a.value.replace(/[^0-9]/g,"")},showNumberDropdownSuggest:function(c){let a=this,b=c.target;if(""===$(b).val()){a.searchForm.numberSuggests=[],a.searchForm.showNumberDropdown=!1;return}$("#searchName").val(""),a.searchForm.nameSuggests=[],a.searchForm.showNameDropdown=!1;let d=$("#startlistTable tbody tr"),e=new RegExp("^"+$(b).val()+"(.*)","i");a.searchForm.numberSuggests=[],d.each(function(){if(e.test($(this).attr("data-number"))){let b={index:$(this).attr("data-index"),number:$(this).attr("data-number"),fullname:$(this).attr("data-fullname")};a.searchForm.numberSuggests.push(b),a.searchForm.showNumberDropdown=!0}})},removeNumberDropdownSuggest:function(a){let b=this,c=a.target;window.setTimeout(function(){$(c).val(""),b.searchForm.numberSuggests=[],b.searchForm.showNumberDropdown=!1},50)},showNameDropdownSuggest:function(c){let a=this,b=c.target;if(""===$(b).val()){a.searchForm.nameSuggests=[],a.searchForm.showNameDropdown=!1;return}$("#searchNumber").val(""),a.searchForm.numberSuggests=[],a.searchForm.showNumberDropdown=!1;let d=$("#startlistTable tbody tr"),e=new RegExp($(b).val()+"(.*)","i");a.searchForm.nameSuggests=[],d.each(function(){if(e.test($(this).attr("data-fullname"))){let b={index:$(this).attr("data-index"),number:$(this).attr("data-number"),fullname:$(this).attr("data-fullname")};a.searchForm.nameSuggests.push(b),a.searchForm.showNameDropdown=!0}})},removeNameDropdownSuggest:function(a){let b=this,c=a.target;window.setTimeout(function(){$(c).val(""),b.searchForm.nameSuggests=[],b.searchForm.showNameDropdown=!1},50)},applyFilter:function(b){let c=b.target,d=$(c).val(),a=$(".startlist-table tbody tr");a.removeClass("d-none"),"0"!==d&&a.each(function(){$(this).attr("data-category")!==d&&$(this).addClass("d-none")})},getFormatedTime:function(a){let b=10>a.getHours()?"0"+a.getHours():a.getHours(),c=10>a.getMinutes()?"0"+a.getMinutes():a.getMinutes(),d=10>a.getSeconds()?"0"+a.getSeconds():a.getSeconds();return b+":"+c+":"+d}}})