const chronometryApp=new Vue({el:"#chronometry-app",data:{isReady:!1,isOnline:"",requestToken:"",modalId:null,currentTime:"",runners:null,categories:null,sidebar:{status:"closed"},modal:{runnerIndex:null,runnerNumber:"",runnerFullname:"",runnerId:null,runnerIsFinisher:!1,runnerdnf:!1,lastChange:"",endTime:""},searchForm:{showNumberDropdown:!1,numberSuggests:[],showNameDropdown:!1,nameSuggests:[]},stats:{total:0,dispensed:0,haveFinished:0,running:0,haveGivenUp:0,runnersTotal:0}},created:function(){const e=this;e.requestToken=CHRONOMETRY.requestToken,e.modalId=CHRONOMETRY.modalId,window.setTimeout(function(){e.isReady=!0},2e3),window.setInterval(function(){e.setTime()},1e3),e.checkOnlineStatus(),window.setInterval(function(){e.checkOnlineStatus()},15e3),e.getDataAll(),$(document).ready(function(){$("#startlistTable").stupidtable()})},methods:{getDataAll:function(){const e=this,t=$.ajax({url:window.location.href,type:"post",dataType:"json",data:{REQUEST_TOKEN:e.requestToken,action:"getDataAll"}});t.done(function(t){e.runners=t.runners,e.stats=t.stats,e.categories=t.categories}),t.fail(function(){alert("XHR-Request fehlgeschlagen!!!")}),t.always(function(){})},openModal:function(e){const t=this,n=t.runners[e],s=t.modal;s.runnerIndex=e,s.runnerNumber=n.number,s.runnerFullname=n.fullname,s.runnerIsFinisher=""!==n.endtime,s.runnerHasNotice=""!==n.notice,s.runnerdnf="1"===n.dnf,s.runnerNotice=n.notice.replace(/&\am\p;/g,"&"),s.runnerId=n.id;const r=new Date(1e3*n.tstamp);s.lastChange="Letzte Änderung: "+t.getFormatedTime(r),s.endTime=""===n.endtime?t.currentTime:n.endtime,s.endTime="1"===n.dnf?"":s.endTime,"1"===n.dnf?document.getElementById("runnerDnfCtrl").checked=!0:document.getElementById("runnerDnfCtrl").checked=!1;let a=document.getElementById(t.modalId);a.addEventListener("hidden.bs.modal",function(){$("html, body").animate({},50,function(){$("#searchNumber").val("").focus(),$("#searchName").val(""),t.searchForm.numberSuggests=[],t.searchForm.nameSuggests=[],t.searchForm.showNumberDropdown=!1,t.searchForm.showNameDropdown=!1})}),a.addEventListener("shown.bs.modal",function(){$("#endtimeCtrl").focus()}),bootstrap.Modal.getOrCreateInstance(a,{keyboard:!1}).show(),$("#inputClear").click(function(){s.endTime=""})},scrollToNumber:function(e){const t=this,n=e.target;if($(n).val()>1){const e=$("tr[data-number='"+$(n).val()+"']");if($(e).length){$("html, body").animate({scrollTop:$(e).offset().top-40},400,function(){});const n=$(e).data("index");t.openModal(n)}}},checkOnlineStatus:function(){const e=this,t=$.ajax({url:window.location.href,type:"post",dataType:"json",data:{action:"checkOnlineStatus",REQUEST_TOKEN:e.requestToken}});t.done(function(t){e.isOnline="success"===t.status}),t.fail(function(){e.isOnline=!1}),t.always(function(){})},validateNumberOnInput:function(e){const t=e.target;isNaN(t.value)&&(t.value="")},saveRow:function(e){const t=this,n=t.runners[e],s=t.modal.runnerId,r=$("#endtimeCtrl").val(),a=$(".modal #runnerDnfCtrl").is(":checked")?1:"";if(/^(([0|1][0-9])|([2][0-3])):([0-5][0-9]):([0-5][0-9])$/.test(r)||""===r){let o=document.getElementById(t.modalId);bootstrap.Modal.getOrCreateInstance(o,{keyboard:!1}).hide(),n.requesting=!0;const i=$.ajax({url:window.location.href,type:"post",dataType:"json",data:{action:"saveRow",REQUEST_TOKEN:t.requestToken,id:s,index:e,endtime:r,dnf:a}});i.done(function(e){"success"===e.status?(n.requesting=!1,t.runners=e.runners,t.stats=e.stats,t.categories=e.categories):alert("Fehler")}),i.fail(function(){alert("XHR-Request für id "+s+" fehlgeschlagen!!!")}),i.always(function(){n.requesting=!1})}else alert("Ungültige Eingabe: "+r)},printCertificate:function(e){window.location.href=window.location.href+"?printCertificate=true&id="+e},setTime:function(){let e=new Date,t=e.getHours(),n=e.getMinutes(),s=e.getSeconds();t<10&&(t="0"+t),n<10&&(n="0"+n),s<10&&(s="0"+s),this.currentTime=t+":"+n+":"+s},setEndTimeFromCurrentTime:function(){const e=this.modal,t=new Date;e.endTime=this.getFormatedTime(t)},clearEndTime:function(){this.modal.endTime=""},showNumberDropdownSuggest:function(e){const t=this,n=e.target;if(""===$(n).val())return t.searchForm.numberSuggests=[],void(t.searchForm.showNumberDropdown=!1);$("#searchName").val(""),t.searchForm.nameSuggests=[],t.searchForm.showNameDropdown=!1;const s=$("#startlistTable tbody tr"),r=new RegExp("^"+$(n).val()+"(.*)","i");t.searchForm.numberSuggests=[],s.each(function(){if(r.test($(this).attr("data-number"))){const e={index:$(this).attr("data-index"),number:$(this).attr("data-number"),fullname:$(this).attr("data-fullname")};t.searchForm.numberSuggests.push(e),t.searchForm.showNumberDropdown=!0}})},removeNumberDropdownSuggest:function(e){const t=this,n=e.target;window.setTimeout(function(){$(n).val(""),t.searchForm.numberSuggests=[],t.searchForm.showNumberDropdown=!1},50)},showNameDropdownSuggest:function(e){const t=this,n=e.target;if(""===$(n).val())return t.searchForm.nameSuggests=[],void(t.searchForm.showNameDropdown=!1);$("#searchNumber").val(""),t.searchForm.numberSuggests=[],t.searchForm.showNumberDropdown=!1;const s=$("#startlistTable tbody tr"),r=new RegExp($(n).val()+"(.*)","i");t.searchForm.nameSuggests=[],s.each(function(){if(r.test($(this).attr("data-fullname"))){const e={index:$(this).attr("data-index"),number:$(this).attr("data-number"),fullname:$(this).attr("data-fullname")};t.searchForm.nameSuggests.push(e),t.searchForm.showNameDropdown=!0}})},removeNameDropdownSuggest:function(e){const t=this,n=e.target;window.setTimeout(function(){$(n).val(""),t.searchForm.nameSuggests=[],t.searchForm.showNameDropdown=!1},50)},toggleSidebar:function(){const e=this;"closed"===e.sidebar.status?e.sidebar.status="open":e.sidebar.status="closed",$("#sidebarContainer").toggleClass("hidden-sidebar")},applyFilter:function(e){const t=e.target,n=$(t).val(),s=$(".startlist-table tbody tr");s.removeClass("d-none"),"0"!==n&&s.each(function(){$(this).attr("data-category")!==n&&$(this).addClass("d-none")})},getFormatedTime:function(e){return(e.getHours()<10?"0"+e.getHours():e.getHours())+":"+(e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes())+":"+(e.getSeconds()<10?"0"+e.getSeconds():e.getSeconds())}}});